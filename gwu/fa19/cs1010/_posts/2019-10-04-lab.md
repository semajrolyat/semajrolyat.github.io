---
layout: post
title:  "Basic Device Development"
date:   2019-10-04 00:00:00 -0400
schedule:   2019-10-04 00:00:00 -0400
categories: [GWU]
docclass: "lab"
gwclass: "cs1010"
term: "fa19"
---
<head>
  <link href="/css/syntax.css" rel="stylesheet">
</head>

# Lab 3 - Basic Device Development

Special thanks to Kartik Bulusu and Bhagirath Narahari for materials related to this lab.

## Introduction

This week we will work with an Arduino, a simple, programmable microcontroller that we can combine with a variety of sensors (see [Introduction to Arduino](https://www.arduino.cc/en/guide/introduction)).  The Arduino platform is very popular among hobbyists and developers because it can be used to model or as a basic platform to base or prototype a simple, interactive device.  


![Arduino Uno]({{ "/gwu/fa19/cs1010/assets/lab3/arduino_image.png" | absolute_url }})

## Overview
Sensor
* Sonar Sensor
* Taking in Data

Microcontroller
* Arduino: UNO
* Capturing Data
* Interfacing Between Hardware and Software

Data Analysis
* Visualization through Python
* Plotting Data to see what occurred

## Ultrasonic Sensors
* Proximity Detection
* Locating Objects
* Ranging Measurements

![Sonar Concept]({{ "/gwu/fa19/cs1010/assets/lab3/sonar_concept.png" | absolute_url }})

Ultrasonic sensors operate by broadcasting noise in a range that is outside of the human hearing range.  We can't hear the noise generated by the sensor but it produces sound waves that bounce off objects and return to the sensor.  The sensor measures distance by measuring the _**time of flight**_ for the electromagnetic waves it produces.  Because these waves travel at a known speed, we can calculate how long the wave took to return to the sensor and then derive the distance the wave traveled during that time.

These same principles are the basis of sonar (typically measuring the time of flight of sound underwater) and lidar (measuring the time of flight of laser light).  Sonar is widely used for detecting and ranging in naval environments.  Lidar is being adopted in a large number of applications where distance measures need to be highly accurate in an air medium.  For example, lidar is now a common and necessary sensor for robotic applications.   

Ultrasonic applications are a little limited due to problems with interference; however, the principles are well known, the sensors are extremely cheap, and the limitations do not inhibit all applications.  These sensors are therefore still useful and also are an affordable gateway to understanding the theory for more sophisticated time of flight sensors.

#### Applications
* Measure liquid levels in tanks
* Measure if an object is approaching or leaving
* Finding a gap


## Parking Assistance

Automotive manufacturers have historically embraced novel technologies as a way to increase the marketability of their products.  Newer automotives are taking advantage of low cost processing and sensors combined with effective controllers to solve long standing problems such as parallel parking through automated parking assistance.  

![Parking Sensors]({{ "/gwu/fa19/cs1010/assets/lab3/application_car.png" | absolute_url }})


## Microcontrollers
* Arduino contains a microcontroller
* Microcontroller is a single-chip Integrated Circuit (IC)
* Has memory, input/output pins and requires an external programming interface
* Extensive community â€“ tons of information on how to use it

![Microcontroller]({{ "/gwu/fa19/cs1010/assets/lab3/microcontroller.png" | absolute_url }})

#### Applications
* Used for interfacing hardware/software, programming, embedded systems
* Used in cars, solar panels, phones, medical systems, etc.

## Arduino IDE

* Suite of tools to write programs for or test Arduino configurations
* Software interface
* Arduino programming uses sets of precompiled C/C++ code

![Arduino Program]({{ "/gwu/fa19/cs1010/assets/lab3/arduino_program.png" | absolute_url }})

### Toolbar

![Arduino Toolbar]({{ "/gwu/fa19/cs1010/assets/lab3/arduino_toolbar.png" | absolute_url }})

* The _**Check Mark**_ compiles and verifies the accuracy of the current code
* The _**Right Arrow**_ uploads the current file to the Arduino Board
* The _**Paper**_ creates a new file
* The _**Up Arrow**_ opens a file
* The _**Down Arrow**_ saves a file
* The _**Magnifying Glass**_ opens the serial monitor

### Software Structure
Variable definitions and libraries are included at the top

In Void Setup
* Data rate is set
* Pin assignments are done

Void Loop
* Main portion of the code
* Setting values, logic is done here, manipulating data, using variables, etc.

The following code is the Blink example with a minor change to fully reflect the notes above:
```c++
#define DELAYTIME 1000    //  a second in microseconds

// the setup function runs once when you press reset or power the board
void setup() {
  // initialize digital pin LED_BUILTIN as an output.
  pinMode(LED_BUILTIN, OUTPUT);    // LED_BUILTIN is 13
}

// the loop function runs over and over again forever
void loop() {
  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)
  delay(DELAYTIME);                  // wait so the light stays on
  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW
  delay(DELAYTIME);                  // wait so the light stays off
}
```

## Components

The Arduino is a microcontroller that can act as the brain of the system.  The Arduino can receive power either through the DC socket or through the USB port.  Along the edges of the board are a set of ports into which a wire can be inserted.  Each of the ports is labeled and has a particular function.  Some supply power (3.5V or 5V), some are grounds (GND), some are programmable, and some have other dedicated capabilities.  There are also a number of LED's on the board.  
![Arduino Diagram]({{ "/gwu/fa19/cs1010/assets/lab3/arduino_diagram.png" | absolute_url }})


A _**breadboard**_ allows us to quickly and safely model a circuit using connectors that do not require soldering.  The breadboard is an insulated block with interconnected wiring runs that can be interconnected using a variety of electronic components.  
![Breadboard]({{ "/gwu/fa19/cs1010/assets/lab3/breadboard.png" | absolute_url }})


_**Jumper wires**_ are low voltage conductors with connectors that can easily interconnect components.  Jumper wires may have different end connectors that facilitate interconnection with a component or a breadboard without the need for soldering.
![Jumper Wires]({{ "/gwu/fa19/cs1010/assets/lab3/jumperwires.png" | absolute_url }})

<!--
![Ultrasonic Sensor]({{ "/gwu/fa19/cs1010/assets/lab3/ultrasonic_diagram.png" | absolute_url }})
-->
There are a large number of sensors or other components provided in the kit; however, we will work exclusively with the sonar sensor in today's lab.  The sensor has a number of pins along one edge of the board.  The following diagram details the role of each of these pins and each is annotated with a label:  

![Ultrasonic Pinout]({{ "/gwu/fa19/cs1010/assets/lab3/ultrasonic_pins.png" | absolute_url }})

When connecting the sensor, make sure to connect the correct ports from the Arduino board to the sensor.  **If you wire the sensor incorrectly, the sensor or the Arduino or both could be damaged.**

## Sensor Program

Download the [Ultrasonic.ino]({{ "/gwu/fa19/cs1010/assets/lab3/Ultrasonic.ino" | absolute_url }}) file.  Save ```Ultrasonic.ino``` to a folder named Ultrasonic.  The code in this file is as follows:

```c++
#define ECHOPIN 2
#define TRIGPIN 3

int distance = 0;
int time = 0;

void setup() {
  Serial.begin(9600);
  pinMode(ECHOPIN, INPUT);
  pinMode(TRIGPIN, OUTPUT);
}

void loop() {
  //time = millis();
  digitalWrite(TRIGPIN, LOW);
  delayMicroseconds(5);
  digitalWrite(TRIGPIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIGPIN, LOW);
  pinMode(ECHOPIN,INPUT);
  distance = pulseIn(ECHOPIN, HIGH);
  distance = distance/(2 * 29.1);
  //Serial.print(time);
  //Serial.print(" ");
  Serial.println(distance);
  delay(50);
}
```

**If your Arduino is connected to a USB port, unplug the USB now.  DO NOT plug the Arduino into a USB port until an instructor has reviewed your wiring and instructs you to connect the Arduino to your computer.**

In general **NEVER** connect power before connecting the ground.

Using jumper wires, connect the ports on the Arduino board to the socket on the breadboard that corresponds to the correct ultrasonic sensor pin in the following order:
1. Connect a ground on the Arduino board to the ground pin (Gnd) on the ultrasonic sensor.
2. Connect power on the Arduino board to the power pin (Vcc) on the ultrasonic sensor.
3. Connect port 2 on the Arduino board to the echo pin (Echo) on the ultrasonic sensor.
4. Connect port 3 on the Arduino board to the trigger pin (Trig) on the ultrasonic sensor.

**Note the following diagram is for wiring reference and does not necessarily reflect the physical arrangement.  The sensor should be pointed away from the jumpers so that the wires do not obstruct the sensor.  If you rotate the sensor, this would reverse the wiring order.  Double check that you are wiring the correct ports to the correct pins.**

![Ultrasonic Wiring]({{ "/gwu/fa19/cs1010/assets/lab3/ultrasonic_wiring.png" | absolute_url }})


## Visualizing Data

Download [oscilloscope.py]({{ "/gwu/fa19/cs1010/assets/lab3/oscilloscope.py" | absolute_url }}) file.  Save ```oscilloscope.py``` in the Ultrasonic folder.  The code in this file is as follows:

```Python
import serial
from collections import deque
import matplotlib.pyplot as plt
import matplotlib.animation as animation

def update(frameNum, plot, ser, buffer, maxLen):
  try:
    line = ser.readline().decode('UTF-8')
    data = [int(val) for val in line.split()]
    if len(buffer) < maxLen:
      buffer.append(data[0])
    else:
      buffer.pop()
      buffer.appendleft(data[0])
    plot.set_data(range(maxLen), buffer)
    print(data[0])
  except KeyboardInterrupt:
    print('Exiting')
  except serial.SerialException:
    print("Error reading from serial port")
    ser.flush()
    ser.close()    
  except ValueError:
    print("Value error, dropping packet.")
  return plot,

strPort = '/dev/ttyACM1'  # The serial port to listen for data on
extens=((0,100),(0,200))  # (x_lo, x_hi),(y_lo, y_hi)

ser = serial.Serial(strPort, 9600)
buf = deque([0.0]*extens[0][1])

fig = plt.figure()
ax = plt.axes(xlim=extens[0], ylim=extens[1])
ax.set_title("Measured Distance")
ax.set_xlabel("Buffered Sample")
ax.set_ylabel("Distance (cm)")
a0, = ax.plot([], [])
anim = animation.FuncAnimation(fig,
                               update,
                               fargs=(a0, ser, buf, extens[0][1]),
                               interval=50)

plt.show()

ser.flush()
ser.close()    

print('Exiting')
```

```oscilloscope.py``` depends on the ```serial``` module.  You will need to install this package.  To install ```serial```, run the following command at the Anaconda prompt:

```
conda install pyserial
```

In ```oscilloscope.py```, make sure that the code connects the serial port to the same serial port that the Arduino is connected on.  Edit the following line and fill in the correct port:

```Python
strPort = '/dev/ttyACM1'
```

```oscilloscope.py``` uses the animation module in ```matplotlib```.  Spyder does not work and play well with this particular module, so you cannot run ```oscilloscope.py``` through Spyder; however, you can still run ```oscilloscope.py``` at the command line.  In the Anaconda prompt, navigate to the folder containing ```oscilloscope.py``` and execute the following command:

```
python oscilloscope.py
```

If everything is properly configured and you have properly executed ```oscilloscope.py```, you should see numbers streaming in the console and python should open a plot window that looks like the following:

![Oscilloscope]({{ "/gwu/fa19/cs1010/assets/lab3/oscilloscope.png" | absolute_url }})

The values plotted in the oscilloscope should relect the distance to the nearest object.  If you place your hand in front of the sensor, the line should drop significantly and the numbers streaming in the console should approach zero.  If you remove your hand, the line should rise sharply and the numbers in the console should significantly increase.  
